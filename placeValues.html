<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Place Value Practice</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>ðŸ§® Place Value Practice</h1>
  
  <label for="level">Choose Level:</label>
  <select id="level" onchange="setLevel()">
    <option value="1">Level 1 (Ones & Tens)</option>
    <option value="2">Level 2 (Hundreds)</option>
    <option value="3">Level 3 (Thousands & Tenths)</option>
    <option value="4">Level 4 (Ten-thousands & Hundredths)</option>
  </select>
  
  <label for="questionCount">Number of Questions:</label>
  <select id="questionCount" onchange="setQuestionCount()">
    <option value="5">5 Questions</option>
    <option value="10">10 Questions</option>
    <option value="20">20 Questions</option>
    <option value="50">50 Questions</option>
    <option value="100">100 Questions</option>
  </select>

  <div id="quizActive">
    <div id="question">Click "Start" to begin the quiz</div>
    
    <input type="text" id="answer" placeholder="Your answer" disabled>
    <button onclick="toggleAction()" id="actionBtn">Start</button>
  </div>

  <div id="feedback"></div>
  <div class="score" id="score"></div>
  <div class="final" id="finalScore"></div>
  <div id="timer" style="font-size:18px; margin-top:10px;"></div>
  <div id="points" style="font-size:20px; margin-top:10px; color:#16a085;"></div>
  
  <button class="back-btn" onclick="location.href='index.html'">â¬… Back to Topics</button>
  <button class="back-btn" onclick="restartQuiz()">ðŸ”„ Restart Quiz</button>
  <script src="scripts.js"></script>
  <script>
    let numberString, digits, correctAnswers;
    let questionCount = 0, correctCount = 0, totalQuestions = 5;
    let level = 0;
    let currentDigitIndex = 0; // which digit we are asking about
    let isAnswerChecked = false; // Track if current answer has been checked
    let isQuizStarted = false; // Track if quiz has been started

    function setLevel() {
      level = parseInt(document.getElementById('level').value);
      resetQuiz();
      resetToStartState();
    }

    function setQuestionCount() {
      totalQuestions = parseInt(document.getElementById('questionCount').value);
      resetQuiz();
      resetToStartState();
    }

    function generateNumber() {
    console.log("Generating number for level", level);
    level = parseInt(document.getElementById('level').value);

    function getUniqueDigits(count, allowZeroFirst = false) {
        let digits = ['0','1','2','3','4','5','6','7','8','9'];
        let result = [];
        if (!allowZeroFirst) digits = digits.slice(1); // remove '0' for first digit
        result.push(digits.splice(Math.floor(Math.random() * digits.length), 1)[0]);
        digits = ['0','1','2','3','4','5','6','7','8','9'].filter(d => !result.includes(d));
        while (result.length < count) {
            let idx = Math.floor(Math.random() * digits.length);
            result.push(digits.splice(idx, 1)[0]);
            }
            return result;
        }

        switch (level) {
            case 1: // 2-digit
            return getUniqueDigits(2, false).join('');
            case 2: // 3-digit
            return getUniqueDigits(3, false).join('');
            case 3: { // 4-digit + tenths
            let intPart = getUniqueDigits(4, false).join('');
            let decimalPart = getUniqueDigits(1, true)[0];
            // Ensure decimal part is different from all integer digits
            while (intPart.includes(decimalPart)) {
                decimalPart = getUniqueDigits(1, true)[0];
            }
            return intPart + '.' + decimalPart;
            }
            case 4: { // 5-digit + hundredths
            let intPart = getUniqueDigits(5, false).join('');
            let decimalPart = getUniqueDigits(2, true).join('');
            // Ensure decimal digits are different from integer digits and each other
            while (intPart.includes(decimalPart[0]) || intPart.includes(decimalPart[1]) || decimalPart[0] === decimalPart[1]) {
                decimalPart = getUniqueDigits(2, true).join('');
            }
            return intPart + '.' + decimalPart;
            }
        }
    }
    function placeValue(digit, position) {
      const powers = ["ones", "tens", "hundreds", "thousands", "ten-thousands"];
      if (position >= 0) {
        return digit * Math.pow(10, position);
      } else {
        return digit * Math.pow(10, position); // for decimals
      }
    }

    function nextQuestion() {
      // Only start timer on first question
      if (questionCount === 0) {
        startTimer();
      }
      
      handleQuizProgress();
      
      // Generate new number for each question (simpler approach)
      numberString = generateNumber().toString();
      digits = numberString.replace(".", "").split("").map(Number);
      correctAnswers = [];

      // Build correct answers based on each digit
      let decimalIndex = numberString.indexOf(".");
      let digitIndex = 0; // Track position in digits array
      
      for (let i = 0; i < numberString.length; i++) {
        if (numberString[i] === ".") continue;
        
        let exp;
        if (decimalIndex === -1) {
          // No decimal point - integer positions
          exp = numberString.length - 1 - i;
        } else {
          // Has decimal point
          if (i < decimalIndex) {
            // Integer part (left of decimal)
            exp = decimalIndex - 1 - i;
          } else {
            // Decimal part (right of decimal)
            exp = decimalIndex - i;
          }
        }
        
        let placeVal = placeValue(digits[digitIndex], exp);
        // Round to avoid floating point precision issues
        placeVal = Math.round(placeVal * 1000000) / 1000000;
        correctAnswers.push(placeVal);
        digitIndex++;
      }

      // Pick a random digit to ask about
      currentDigitIndex = Math.floor(Math.random() * digits.length);
      let digitChar = digits[currentDigitIndex];
      
      document.getElementById('question').innerText =
        `Q${questionCount + 1}: Number is ${numberString}. What is the value of ${digitChar}?`;

      document.getElementById('answer').value = "";
      document.getElementById('feedback').innerText = "";
      document.getElementById('answer').disabled = false;
      document.getElementById('actionBtn').innerText = "Check";
      document.getElementById('actionBtn').disabled = false;
      isAnswerChecked = false;
      
      // Focus on the input field for immediate typing
      setTimeout(() => {
        document.getElementById('answer').focus();
      }, 10);
    }

    function checkAnswer() {
      let userAnswer = document.getElementById('answer').value.trim();
      let feedback = document.getElementById('feedback');
      
      // Convert user answer to number for comparison
      let userNum = parseFloat(userAnswer);
      let correctNum = correctAnswers[currentDigitIndex];
      
      // Check if answer is correct (with tolerance for floating point precision)
      if (!isNaN(userNum) && Math.abs(userNum - correctNum) < 0.00001) {
        feedback.innerText = "âœ… Correct!";
        feedback.className = "correct";
        correctCount++;
      } else {
        feedback.innerText = `âŒ Wrong. Correct answer is ${correctNum}`;
        feedback.className = "wrong";
      }

      questionCount++;

      document.getElementById('score').innerText = `Score: ${correctCount}/${questionCount}`;
      document.getElementById('answer').disabled = true;
      document.getElementById('actionBtn').innerText = "Next Question";
      isAnswerChecked = true;
      
      // Check if quiz is complete and show certificate based on points
      if (questionCount >= totalQuestions) {
        // Stop the timer when quiz is complete
        stopTimer();
        document.getElementById('actionBtn').disabled = true;
        
        // Show final score and points
        let timeUsed = elapsedTime || 1;
        let level = parseInt(document.getElementById('level').value, 10);
        let points = Math.round((correctCount / timeUsed) * 100 * Math.sqrt(level));
        document.getElementById('finalScore').innerText = 
          `ðŸŽ‰ Quiz Finished! You got ${correctCount} out of ${totalQuestions} correct.`;
        document.getElementById('points').innerText = `Points: ${points}`;
        document.getElementById('quizActive').style.display = 'none';
        
        setTimeout(() => {
          if (points >= 50) { // Minimum threshold for any certificate
            showCertificate(points, correctCount, totalQuestions, level, elapsedTime);
          }
        }, 1000); // Small delay to let the final score display first
      }
    }

    function resetQuiz() {
      questionCount = 0;
      correctCount = 0;
      currentDigitIndex = 0;
      document.getElementById('score').innerText = "";
      document.getElementById('finalScore').innerText = "";
    }

    function resetToStartState() {
      document.getElementById('question').innerText = `Click "Start" to begin the quiz`;
      document.getElementById('answer').value = "";
      document.getElementById('answer').disabled = true;
      document.getElementById('feedback').innerText = "";
      document.getElementById('actionBtn').innerText = "Start";
      document.getElementById('actionBtn').disabled = false;
      isAnswerChecked = false;
      isQuizStarted = false;
      
      // Focus the button so Enter key works
      const actionBtn = document.getElementById('actionBtn');
      if (actionBtn) {
        actionBtn.focus();
      }
    }

    function restartQuiz() {
      // Reset all quiz variables
      questionCount = 0;
      correctCount = 0;
      isAnswerChecked = false;
      isQuizStarted = false;
      currentDigitIndex = 0;
      
      // Reset the quiz using the existing resetQuiz function from scripts.js
      resetQuiz();
      
      // Reset to start state
      resetToStartState();
      
      // Show quiz area if it was hidden
      document.getElementById('quizActive').style.display = 'block';
    }

    function startQuiz() {
      isQuizStarted = true;
      nextQuestion();
    }

    function toggleAction() {
      if (!isQuizStarted) {
        startQuiz();
      } else if (isAnswerChecked) {
        nextQuestion();
      } else {
        checkAnswer();
      }
    }

    function handleEnterKey(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        const actionBtn = document.getElementById('actionBtn');
        if (actionBtn && !actionBtn.disabled) {
          toggleAction();
        }
      }
    }

    // Add global key listener when page loads
    document.addEventListener('keydown', handleEnterKey);
    
    // Focus the button when page loads so Enter key works immediately
    document.addEventListener('DOMContentLoaded', function() {
      const actionBtn = document.getElementById('actionBtn');
      if (actionBtn) {
        actionBtn.focus();
      }
    });
  </script>
</body>
</html>
